# Scryfall MCP Server - AI Agent Instructions

このドキュメントは、Scryfall MCP Serverプロジェクトに対する重要な設計思想、技術的制約、および改善課題をまとめたものです。

## プロジェクト概要

Magic: The GatheringのカードデータをMCP (Model Context Protocol)経由でAIアシスタントに提供するサーバー。Scryfall APIとの統合により、日本語を含む自然言語でのカード検索機能を提供します。

## 重要な技術的制約

### Scryfall API制約
- **レート制限**: 最大10 requests/second、リクエスト間隔75-100ms以上を維持
- **必須HTTPヘッダー**: `User-Agent`と`Accept`ヘッダーがないと403でブロック
- **データ制限**: 1ページ最大175カード

### 開発規約
- **型ヒント必須**: PEP585準拠、pydanticベース
- **docstring必須**: Numpy styleで記載
- **非同期処理**: すべてのI/O処理はasync/await
- **早期リターン推奨**: 深いネスト回避

## 現在の主要な設計課題

### 1. 並行性の問題 🚨
**問題**: グローバルなロケール管理により、並行リクエスト間で言語設定が干渉
```python
# src/scryfall_mcp/tools/search.py:67-68
set_current_locale(language or "en")  # グローバル状態を変更
```

**解決策**:
- `contextvars`またはリクエストスコープの依存性注入を使用
- 並行する日本語・英語検索が互いに影響しないよう改修

### 2. 責任の混在
**問題**: `CardSearchTool.execute`メソッドに以下の責任が集中
- バリデーション
- ロケール処理
- 自然言語処理
- API呼び出し
- 出力フォーマット

**解決策**:
- パーサー → クエリビルダー → プレゼンターに分離
- 各コンポーネントの単体テストを可能にする

### 3. 未実装のキャッシュシステム 🚨
**現状**:
- 設定にキャッシュ項目はあるが実装は空
- `src/scryfall_mcp/cache/__init__.py` は空ファイル
- レート制限とレイテンシの最適化機会を逸している

**改善必要**:
- メモリ + Redis の2層キャッシュ実装
- クエリパラメータベースのキーイング
- TTL設定（検索結果30分、カード詳細24時間、価格6時間）

### 4. 静的な日本語マッピング
**問題**:
- 日本語カード名辞書は一部の有名カードのみ
- 新カードへの対応が手動で困難
- `src/scryfall_mcp/i18n/mappings/ja.py:339-407`

**改善案**:
- 日本語トークナイザー（MeCab、SudachiPy）統合
- ベクター検索による意図検出
- 動的カード名ルックアップ

### 5. MCP機能の未活用
**問題**:
- fastmcpの豊富なコンテンツタイプ（画像、構造化データ）が文字列に変換される
- `src/scryfall_mcp/server.py:103-112` でデータが失われる

**改善**: 構造化MCPコンテンツを返してメタデータや画像URLを保持

## 必要な追加技術・機能

### 観測可能性
- 構造化ログ、メトリクス、トレーシング
- API呼び出しとレート制限状態の監視
- 運用者がScryfall制限接近を把握可能

### Redis統合
- 現在は依存関係に含まれているが実装なし
- 設定検証とヘルスチェック追加
- または実装まで依存関係から削除

### エラーハンドリング強化
- ステータス別（429 vs 5xx）の詳細エラー情報
- 日本語・英語両方での実行可能なガイダンス
- 部分応答の回避

### 運用機能
- グレースフルシャットダウン
- レディネスプローブ
- キャッシュのウォームアップとリロード機能

## コード品質チェックリスト

### 必須実行コマンド
```bash
# リント・フォーマット
uv run ruff check src/ tests/ --fix
uv run ruff format src/ tests/

# 型チェック（STRICT mode）
uv run mypy src/

# テスト（カバレッジ95%目標）
uv run pytest --cov=scryfall_mcp --cov-report=term-missing
```

### テスト方針
- Scryfall APIはモック化必須
- 非同期処理はpytest-asyncio使用
- 並行性テストを含む多言語検索の回帰テスト

## セキュリティガイドライン

- 環境変数で機密情報管理
- 入力値サニタイズ必須
- ログに個人情報・APIキー出力禁止
- Wizards of the Coastファンコンテンツポリシー遵守

## 開発優先順位

1. **High Priority** 🚨
   - 並行ロケール管理の修正
   - キャッシュシステムの実装
   - 構造化MCPレスポンス対応

2. **Medium Priority**
   - 検索ツールの責任分離
   - エラーハンドリング強化
   - 観測可能性の追加

3. **Low Priority**
   - 日本語NLP強化
   - Redis統合完成
   - 運用管理機能

このドキュメントは定期的に更新し、設計決定と技術的負債の現状を反映させること。